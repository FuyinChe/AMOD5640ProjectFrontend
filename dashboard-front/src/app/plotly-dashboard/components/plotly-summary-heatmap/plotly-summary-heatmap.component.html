<div class="summary-heatmap-table__wrapper">
  <div *ngIf="isLoading" class="summary-heatmap-table__loading">
    <div class="summary-heatmap-table__spinner"></div>
    <p>Loading overview data...</p>
  </div>
  
  <div *ngIf="error" class="summary-heatmap-table__error">
    <p>{{ error }}</p>
  </div>
  
  <ng-container *ngIf="!isLoading && !error">
    <div class="summary-heatmap-table__download-buttons">
      <button 
        class="summary-heatmap-table__download-btn summary-heatmap-table__download-btn--csv" 
        (click)="downloadCSV()"
        title="Download data as CSV file">
        <i class="fas fa-file-csv"></i>
        CSV
      </button>
      <button 
        class="summary-heatmap-table__download-btn summary-heatmap-table__download-btn--png" 
        (click)="downloadPNG()"
        title="Download table as PNG image">
        <i class="fas fa-file-image"></i>
        PNG
      </button>
    </div>
    
    <div class="summary-heatmap-table__legend" #legendContainer>
      <div class="summary-heatmap-table__legend-title">Color Scale (per metric row):</div>
      <div class="summary-heatmap-table__legend-items">
        <div class="summary-heatmap-table__legend-item">
          <div class="summary-heatmap-table__legend-color" style="background: #1e40af;"></div>
          <span>Lowest values</span>
        </div>
        <div class="summary-heatmap-table__legend-item">
          <div class="summary-heatmap-table__legend-color" style="background: #3b82f6;"></div>
          <span>Low values</span>
        </div>
        <div class="summary-heatmap-table__legend-item">
          <div class="summary-heatmap-table__legend-color" style="background: #ffffff; border: 1px solid #e2e8f0;"></div>
          <span>Middle values</span>
        </div>
        <div class="summary-heatmap-table__legend-item">
          <div class="summary-heatmap-table__legend-color" style="background: #f97316;"></div>
          <span>High values</span>
        </div>
        <div class="summary-heatmap-table__legend-item">
          <div class="summary-heatmap-table__legend-color" style="background: #ea580c;"></div>
          <span>Highest values</span>
        </div>
        <div class="summary-heatmap-table__legend-item">
          <div class="summary-heatmap-table__legend-color" style="background: #f8fafc;"></div>
          <span>No data</span>
        </div>
      </div>
      <div class="summary-heatmap-table__legend-note">
        <small>* Colors are relative to each metric's min/max range across all displayed data</small>
      </div>
    </div>
    
    <div class="summary-heatmap-table__container" [style.overflow-x]="containerOverflow">
      <div class="summary-heatmap-table__inner-wrapper">
        <table #heatmapTable class="summary-heatmap-table" role="table" aria-label="Environmental Data Overview" [style.width]="tableWidth">
          <thead>
            <tr>
              <th class="summary-heatmap-table__metric-header" scope="col" rowspan="2">Measurement</th>
              <th class="summary-heatmap-table__submetric-header" scope="col" rowspan="2">Parameter</th>
              <th 
                *ngFor="let group of yearGroups"
                class="summary-heatmap-table__year-header" 
                scope="col"
                [attr.colspan]="group.count"
                [attr.aria-label]="'Year ' + group.year">
                {{ group.year }}
              </th>
            </tr>
            <tr>
              <th 
                *ngFor="let month of months; let i = index" 
                class="summary-heatmap-table__month-header" 
                scope="col"
                [attr.aria-label]="'Data for ' + month">
                {{ getMonthFromLabel(month) }}
              </th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let group of groupedMetrics">
              <tr *ngFor="let metric of group.metrics; let metricIdx = index">
                <th 
                  *ngIf="metricIdx === 0"
                  class="summary-heatmap-table__metric-group" 
                  [attr.rowspan]="group.metrics.length"
                  scope="rowgroup">
                  {{ group.group }}
                </th>
                <td class="summary-heatmap-table__metric-name" scope="row" [attr.aria-label]="metric.name + (metric.unit ? ' in ' + metric.unit : '')">
                  {{ getMetricSuffix(metric.name) }}<span *ngIf="metric.unit"> ({{ metric.unit }})</span>
                </td>
                <ng-container *ngIf="metric.values && metric.values.length">
                  <ng-container *ngIf="getRowMinMax(metric.values) as minmax">
                    <td 
                      *ngFor="let value of metric.values; let colIndex = index"
                      [ngStyle]="{'background': getCellColor(value, minmax.min, minmax.max)}"
                      class="summary-heatmap-table__cell"
                      [attr.aria-label]="getCellAriaLabel(value, metric.name, months[colIndex])"
                      role="cell">
                      <span *ngIf="value !== null && value !== undefined">
                        {{ value | number:'1.2-2' }}
                      </span>
                      <span *ngIf="value === null || value === undefined" aria-label="No data available">
                        -
                      </span>
                    </td>
                  </ng-container>
                </ng-container>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </ng-container>
</div> 